# v2.7.5-beta.2 - Position Limit Logic Fix + Code Simplification

## üéØ Critical Bug Fix + Refactoring

This beta release includes the bug fix from beta.1 **plus** additional code simplification based on user feedback.

## üêõ Bug Fixed (from beta.1)

**Issue #24: Invalid sunset cover position**

Users with `enable_min_position = True` (only apply when sun in window) experienced incorrect behavior where covers would go to `min_position` instead of `sunset_position` after sunset.

**Example:**
- Configuration: `min_position = 35`, `enable_min_position = True`, `sunset_position = 0`
- **Bug:** Cover went to position 35 after sunset
- **Fixed:** Cover now correctly goes to position 0 after sunset

## ‚ú® New in Beta.2: Code Simplification

**User suggestion (theGressier):** Remove redundant property layer and pass configuration booleans directly.

### What Changed
Removed intermediate `apply_min_position` and `apply_max_position` properties that simply returned the configuration boolean. Now passes `min_pos_bool` and `max_pos_bool` directly to the position limits utility.

### Benefits
- **36 fewer lines of code**
- **More direct logic** - Clearer what's happening
- **Better maintainability** - One less layer of indirection
- **Improved coverage** - calculation.py now at 91% (was 47%)
- **Safer** - Less chance of future bugs like the one we just fixed

## üîß Technical Changes Summary

### From Beta.1
1. **Fixed inverted boolean logic** in position limit properties
2. **Changed `&` to `and`** in `direct_sun_valid` (more Pythonic)
3. **Added 14 comprehensive tests** for position limits

### New in Beta.2
4. **Removed redundant properties** - Simplified code by 36 lines
5. **Updated 2 call sites** to use config booleans directly
6. **Removed 4 property-specific tests** (behavioral tests remain)

## üß™ Testing

### Test Results
- **264 total tests** (268 - 4 removed property tests)
- **100% pass rate**
- **91% coverage** on calculation.py (improved from 47%)
- All behavioral tests pass - refactoring maintains correctness

### Test Scenarios Covered
- Min/max position with `enable_min/max_position = False` (always apply)
- Min/max position with `enable_min/max_position = True` (conditional)
- Sunset position interaction with min/max limits
- Regression test for issue #24

## ‚ö†Ô∏è Breaking Change Notice

**This fix changes behavior for affected users - but the previous behavior was a BUG.**

### Who is Affected?
Users with either:
- `enable_min_position = True` (only apply when sun in window)
- `enable_max_position = True` (only apply when sun in window)

### What Changes?
**Before (Bug):** Limits were always applied, even after sunset
**After (Fix):** Limits only apply when sun is in window (as intended)

### Expected Behavior After Update
- After sunset, covers will correctly use `sunset_position`
- During sun in window, covers will respect `min_position`/`max_position` as configured
- Users with `enable_min/max_position = False` (always apply) are not affected

## üìã Related

- Fixes: [Issue #24](https://github.com/jrhubott/adaptive-cover/issues/24)
- Pull Request: [#25](https://github.com/jrhubott/adaptive-cover/pull/25)
- User suggestion credit: @theGressier

## üöÄ Installation

### HACS (Recommended for Beta Testing)

1. Go to HACS ‚Üí Integrations
2. Click the three dots on Adaptive Cover Pro
3. Click "Redownload"
4. Select version `2.7.5-beta.2`
5. Restart Home Assistant

### Manual Installation

1. Download `adaptive_cover_pro.zip` from this release
2. Extract to `custom_components/adaptive_cover_pro/`
3. Restart Home Assistant

## üß™ Beta Testing Instructions

**Please test if you:**
- Use `enable_min_position = True` or `enable_max_position = True`
- Use `sunset_position` to return covers to a specific position after sunset
- Have experienced the bug described in issue #24

**What to test:**
1. Verify covers go to `sunset_position` after sunset (not `min_position`)
2. Verify covers respect `min_position` during sun in window
3. Check logs for any errors or warnings
4. Report any issues in [Issue #24](https://github.com/jrhubott/adaptive-cover/issues/24)

## üìù Testing Checklist

- [ ] After sunset, cover position matches `sunset_position` (not `min_position`)
- [ ] During sun in window, `min_position` is respected
- [ ] During sun in window, calculated position >= `min_position`
- [ ] No errors in Home Assistant logs
- [ ] Cover responds normally to manual control
- [ ] Automation switch still functions correctly

## ‚ö° Performance & Code Quality

- **Code reduced by 36 lines** (178 lines removed, 4 added)
- **Coverage improved** from 47% to 91% on calculation.py
- **More maintainable** - Direct, clear logic
- **Same performance** - No performance impact

## üìö Documentation

- Updated docstrings for clarified behavior
- Simplified call sites show intent more clearly
- Comprehensive test documentation

## üôè Credits

- **Bug report:** @theGressier
- **Code simplification suggestion:** @theGressier
- Both the `&` vs `and` observation and the property removal suggestion came from user feedback!

---

**Note:** This is a **beta release** for testing purposes. Please report any issues before the stable release.

**Changes from beta.1:** Added code simplification based on user feedback - removed redundant properties and improved code quality.
