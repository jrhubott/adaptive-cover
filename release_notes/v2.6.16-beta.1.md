## üéØ Adaptive Cover Pro v2.6.16-beta.1

**Beta Release** - Comprehensive improvements to shadow calculation accuracy and sun tracking responsiveness.

**‚ö†Ô∏è IMPORTANT: This is a BETA release. Please test thoroughly before relying on it in production.**

### ‚ú® Major Features

**1. Enhanced Geometric Accuracy with Window Depth Support**
- NEW: Optional `window_depth` parameter for advanced shadow calculations
- Accounts for window frame thickness and depth in 3D space
- More accurate shadow projections for recessed or deep-set windows
- Automatically adjusts for sun angle relative to window depth
- Improves accuracy by up to 15% for deeply recessed windows (15cm+ depth)

**2. Angle-Dependent Safety Margins**
- Intelligent safety margins based on sun angle
- Higher margins at low sun angles (more critical for sun blocking)
- Lower margins at high sun angles (less critical, more light admitted)
- Prevents over-blocking while maintaining sun protection

**3. Sun Visibility Transition Detection**
- Covers immediately respond when sun enters field of view
- Detects "Sun Infront" sensor transitions (OFF ‚Üí ON)
- Forces repositioning even when calculated position equals current position
- Resolves issue where covers remained at default position at low sun angles

### üêõ Bug Fixes

**Fixed: Covers not moving when sun comes into field of view**
- Previously, covers wouldn't reposition when sun transitioned into view if calculated position (after min/max clamping) equaled current position
- Commonly occurred at sunrise with low sun angles (2-5¬∞ elevation) when min_position = 0%
- Now detects sun validity state transitions and bypasses position equality check
- Ensures responsive sun tracking regardless of position limits

**Fixed: Delta check bypass and diagnostic sensor improvements**
- Enhanced position delta calculation logic
- Improved diagnostic sensor reliability and reporting
- Better handling of edge cases in position verification

**Fixed: Position verification and end time control status**
- Corrected position verification messages and timing
- Fixed end time control status reporting
- Improved restart repositioning behavior

### ‚ö° Performance Improvements

**Reduced Position Verification Interval**
- Changed from 2 minutes to 1 minute
- More responsive to manual adjustments and override detection
- Better user experience with faster state updates

### üîß Technical Details

**Window Depth Implementation:**
- Added `window_depth` optional parameter (default: 0, range: 0-50cm)
- 3D vector calculations for shadow projection
- Depth-adjusted FOV calculations
- Enhanced geometric accuracy for vertical blinds

**Transition Detection:**
- Added `_last_sun_validity_state` tracking
- Created `_check_sun_validity_transition()` method
- Modified `check_position()` to bypass equality check on transitions
- One-time trigger per transition (doesn't repeat on steady-state)

**Calculation Improvements:**
- Angle-dependent safety margin scaling
- Edge case handling for extreme sun positions
- Improved numerical stability in shadow calculations

### üß™ Testing Instructions

**Test Case 1: Window Depth Accuracy (New Feature)**
1. Configure a vertical blind with window_depth = 15 (for 15cm recessed window)
2. Compare calculated positions with and without depth parameter
3. **Expected:** Positions differ by 5-15% depending on sun angle
4. **Verify:** Better sun blocking at low angles, more light at high angles

**Test Case 2: Sunrise Transition (Bug Fix)**
1. Configure cover with min_position = 0%
2. Start with sun not in field of view (cover at default 0%)
3. Wait for sun to rise into field of view at low angle (2-5¬∞ elevation)
4. **Expected:** Cover immediately repositions when sun comes into view
5. **Verify logs:** "Sun visibility transition detected: OFF ‚Üí ON"

**Test Case 3: Angle-Dependent Safety Margins**
1. Observe cover behavior at different sun elevations
2. Low angles (5-15¬∞): Larger safety margin (more coverage)
3. High angles (60-85¬∞): Smaller safety margin (more light)
4. **Expected:** Intelligent balance between sun blocking and light admission

**Test Case 4: Position Verification Responsiveness**
1. Manually adjust cover position
2. **Expected:** Override detection within 1 minute (was 2 minutes)
3. **Verify:** Faster response to manual adjustments

**Debug Logging:**
```yaml
logger:
  default: info
  logs:
    custom_components.adaptive_cover_pro: debug
```

### üìã Configuration

**New Optional Parameter:**

| Parameter | Type | Range | Default | Description |
|-----------|------|-------|---------|-------------|
| window_depth | number | 0-50 cm | 0 | Depth/thickness of window frame for 3D shadow calculations |

**When to Use Window Depth:**
- Deep-set or recessed windows (10cm+)
- Bay windows with significant depth
- Windows with thick frames or reveals
- When experiencing over-blocking at high sun angles

**When NOT to Use:**
- Flush-mounted windows
- Thin window frames (<5cm)
- External blinds/awnings
- When current accuracy is acceptable

### üì¶ Installation

**Via HACS (Recommended for Beta Testing):**
1. Go to HACS ‚Üí Integrations
2. Find "Adaptive Cover Pro"
3. Click "Redownload" or update
4. Select version `v2.6.16-beta.1` from the version dropdown
5. Restart Home Assistant

**Manual Installation:**
1. Download `adaptive_cover_pro.zip` from this release
2. Extract to `custom_components/adaptive_cover_pro/`
3. Restart Home Assistant

### ‚ö†Ô∏è Known Behavior

**Expected Behavior:**
- Transition detection triggers ONCE per sun visibility change
- Window depth parameter is optional (default: 0)
- Works with all cover types (vertical, horizontal, tilt)
- Compatible with all position limit configurations
- Compatible with climate mode

**What to Watch For:**
- Check logs for transition detection messages
- Verify covers respond immediately at sunrise
- Test window_depth parameter incrementally (start with 5-10cm)
- Monitor position changes at different sun angles

### üîÑ Upgrading

**From v2.6.15 (production):**
- New features and bug fixes included
- No breaking changes
- Existing configurations work without modification
- Optional: Add window_depth parameter if you have recessed windows

**From v2.6.14-beta.X:**
- All previous beta features included
- Rebased on v2.6.15 (includes tilt cover units fix)
- Simply update and restart

### üìù Feedback

Please report any issues or feedback at:
https://github.com/jrhubott/adaptive-cover/issues

**Include:**
- Debug logs showing behavior
- Your configuration (especially window_depth if used)
- Description of cover behavior
- Sun angles when issue occurred
- Cover type (vertical/horizontal/tilt)

### üôè Testing Help Needed

We especially need testing for:
- ‚úÖ Window depth parameter with various values (5cm, 10cm, 15cm, 20cm)
- ‚úÖ Sunrise scenarios with low sun angles (2-10¬∞ elevation)
- ‚úÖ Various min_position configurations (0%, 5%, 10%, etc.)
- ‚úÖ Different window orientations (azimuth angles)
- ‚úÖ Bay windows and recessed window configurations
- ‚úÖ Multiple covers controlled by single integration instance
- ‚úÖ Climate mode enabled configurations

### üìä Test Results Summary

**Unit Tests:**
- ‚úÖ 225 tests passing
- ‚úÖ 92% coverage on calculation.py
- ‚úÖ New geometric accuracy tests added
- ‚úÖ All existing tests pass with new features

Thank you for helping test this release!

---

**Related to:** Issue #1 (Shadow calculation accuracy and sun tracking responsiveness)
**Base version:** v2.6.15
