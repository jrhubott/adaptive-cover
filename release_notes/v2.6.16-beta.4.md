## üéØ Adaptive Cover Pro v2.6.16-beta.4

**Beta Release** - Fixed minimum position adjustment setting being ignored.

**‚ö†Ô∏è IMPORTANT: This is a BETA release. Please test thoroughly before relying on it in production.**

### üêõ Bug Fixes

**Fixed: Minimum Position Adjustment (delta_position) Setting Ignored (Issue #10)**

Users reported that despite setting "Minimum Position Adjustment" to 10-20%, covers were still making 1% adjustments throughout the day, causing constant small movements and frustrating "stairstepping" behavior.

**Root Cause:**
Three code paths were bypassing the `check_position_delta()` validation, allowing small position adjustments regardless of the configured minimum threshold:

1. **Timed Refresh (End Time)** - When end time was reached, covers moved to sunset position without checking delta
2. **Position Verification Retry** - Every minute, the position verification system retried failed positions without checking delta
3. **Manual Override Reset Button** - The reset button moved covers without checking delta

**Solution:**
Added `check_position_delta()` validation to all three bypass paths to consistently enforce the minimum position adjustment threshold.

**What Changed:**
- `coordinator.py` line 586: Timed refresh now checks delta before moving to sunset position
- `coordinator.py` line 1417: Position verification retry now checks delta before retrying
- `button.py` line 85: Manual override reset button now checks delta before moving covers

**Important:** Special positions (0%, 100%, default height, sunset position) still work regardless of delta_position threshold as intended.

### ‚ú® Expected Behavior After Fix

**Before:**
- Covers made 1% adjustments "all day long"
- Position verification created constant small movements
- End time triggered 1% adjustments
- Frustrating "stairstepping" behavior in position history

**After:**
- Covers only move when position changes by configured minimum (10-20%)
- Fewer, larger adjustments as intended by user settings
- Special positions (0, 100, sunset) still work correctly
- Clean position history charts with meaningful movements

### üß™ Testing Instructions

**Test Case 1: Timed Refresh (End Time)**
1. Set delta_position to 20%
2. Set sunset position close to current position (within 5%)
3. Wait for end time to trigger
4. **Expected:** Cover does NOT move (delta too small)
5. Set sunset position far from current (>20%)
6. **Expected:** Cover DOES move

**Test Case 2: Position Verification**
1. Set delta_position to 20%
2. Manually nudge cover by 1-2% away from calculated position
3. Watch position verification logs (every 1 minute)
4. **Expected:** No retry attempts, no "stairstep" adjustments
5. **Verify logs:** "Position verification: delta too small for..."

**Test Case 3: Manual Override Reset Button**
1. Set delta_position to 20%
2. Trigger manual override (move cover manually by >20%)
3. Move cover back to within 5% of calculated position
4. Press "Reset Manual Override" button
5. **Expected:** Cover does NOT move, manual override flag is reset
6. **Verify logs:** "Manual override reset: delta too small for..."

**Test Case 4: Normal Sun Tracking**
1. Set delta_position to 20%
2. Let sun move throughout day
3. **Expected:** Cover only moves when position changes by 20%+
4. **Verify:** Fewer, larger position adjustments

**Test Case 5: Special Positions Still Work**
1. Set delta_position to 20%
2. Test moving to 0% (fully closed)
3. Test moving to 100% (fully open)
4. Test moving to default height
5. Test moving to sunset position
6. **Expected:** All special positions work regardless of current position

**Debug Logging:**
```yaml
logger:
  default: info
  logs:
    custom_components.adaptive_cover_pro: debug
```

Look for these log messages:
- "Timed refresh: delta too small for..., skipping"
- "Position verification: delta too small for..."
- "Manual override reset: delta too small for..."
- "Bypassing delta check: moving TO special position"

### üìã Configuration

This fix affects the existing **Minimum Position Adjustment** setting:

| Setting | Location | Effect |
|---------|----------|--------|
| Minimum Position Adjustment (delta_position) | Automation Settings | Now properly enforced in ALL code paths |

**No configuration changes needed** - existing settings now work as originally intended.

### üîß Technical Details

**Code Changes:**

1. **coordinator.py - async_handle_timed_refresh()** (lines 586-605)
   - Added delta check before calling `async_set_manual_position()`
   - Logs when timed refresh is skipped due to small delta

2. **coordinator.py - _verify_entity_position()** (lines 1417-1428)
   - Added delta check before position verification retry
   - Resets retry count when delta too small
   - Logs when position verification retry is skipped

3. **button.py - async_press()** (lines 85-99)
   - Added delta check before moving cover during reset
   - Logs when reset movement is skipped
   - Manual override flag still resets regardless

**Test Coverage:**
- Created `tests/test_delta_position.py` with 6 comprehensive test cases
- All tests passing
- Tests verify both threshold enforcement and special position exceptions

### üì¶ Installation

**Via HACS (Recommended for Beta Testing):**
1. Go to HACS ‚Üí Integrations
2. Find "Adaptive Cover Pro"
3. Click "Redownload" or update
4. Select version `v2.6.16-beta.4` from the version dropdown
5. Restart Home Assistant

**Manual Installation:**
1. Download `adaptive_cover_pro.zip` from this release
2. Extract to `custom_components/adaptive_cover_pro/`
3. Restart Home Assistant

### üîÑ Upgrading

**From v2.6.16-beta.3:**
- New bug fix for delta_position enforcement
- No breaking changes
- Existing configurations work without modification

**From v2.6.15 (production):**
- Includes all beta features from beta.1, beta.2, beta.3
- Minimum position adjustment now works correctly
- No configuration changes needed

### ‚ö†Ô∏è Known Behavior

**Expected Behavior:**
- Delta check applies to normal sun tracking, timed refresh, position verification, and button reset
- Special positions (0%, 100%, default height, sunset) bypass delta check as intended
- Manual override detection still works correctly
- Covers make fewer, larger adjustments

**What to Watch For:**
- Monitor position history charts for fewer, larger adjustments
- Check debug logs for delta check messages
- Verify special positions still work correctly
- Test manual override reset button behavior

### üìù Feedback

Please report any issues or feedback at:
https://github.com/jrhubott/adaptive-cover/issues/10

**Include:**
- Debug logs showing behavior
- Your delta_position setting
- Description of when small movements occur (if any)
- Position history charts (if available)

### üôè Testing Help Needed

We especially need testing for:
- ‚úÖ Various delta_position values (5%, 10%, 15%, 20%)
- ‚úÖ Timed refresh with sunset position close to current position
- ‚úÖ Position verification with small position differences
- ‚úÖ Manual override reset button with small deltas
- ‚úÖ Special positions (0%, 100%, default, sunset) still work
- ‚úÖ Multiple covers controlled by single integration instance

### üìä Test Results Summary

**Unit Tests:**
- ‚úÖ 6 new tests added for delta_position enforcement
- ‚úÖ All 6 tests passing
- ‚úÖ Tests verify threshold enforcement and special position exceptions
- ‚úÖ All existing tests continue to pass

Thank you for helping test this release!

---

**Fixes:** Issue #10 (Minimum Position Adjustment setting ignored)
**Base version:** v2.6.16-beta.3
