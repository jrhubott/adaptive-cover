## üéØ Adaptive Cover Pro v2.6.16

**Stable Release** - Major improvements to shadow calculation accuracy and bug fixes.

### ‚ú® New Features

**Enhanced Geometric Accuracy with Window Depth Support**

This release significantly improves shadow calculation accuracy at extreme sun angles, addressing Issue #1 where users experienced inaccurate blind positions at low and high sun elevations.

**Key Improvements:**
- Angle-dependent safety margins that adapt based on sun position (0-35% additional coverage at extreme angles)
- Intelligent edge case handling for extreme sun positions (elevation < 2¬∞, |gamma| > 85¬∞, elevation > 88¬∞)
- Optional `window_depth` parameter for windows with significant frame depth or reveals (0-50cm range)
- Smooth transitions between angle ranges using smoothstep interpolation

**When Window Depth Helps:**
- Deep-set or recessed windows (10cm+)
- Bay windows with significant depth
- Windows with thick frames or reveals
- When experiencing over-blocking at high sun angles

**Sun Visibility Transition Detection**

Covers now immediately respond when the sun enters the field of view:
- Detects when "Sun Infront" binary sensor transitions from OFF ‚Üí ON
- Forces repositioning even when calculated position equals current position
- Resolves issue where covers remained at default position at low sun angles
- Particularly helpful at sunrise with low sun elevations (2-5¬∞)

### üêõ Bug Fixes

**Fixed: Minimum Position Adjustment Setting Ignored (Issue #10)**

Users reported that despite setting "Minimum Position Adjustment" to 10-20%, covers were still making 1% adjustments throughout the day, causing frustrating "stairstepping" behavior.

**Root Cause:**
Three code paths were bypassing the `check_position_delta()` validation:
1. Timed refresh (end time) - Moving to sunset position
2. Position verification retry - Every minute retry attempts
3. Manual override reset button - Reset without delta check

**Solution:**
All three bypass paths now properly enforce the minimum position adjustment threshold. Special positions (0%, 100%, default height, sunset position) continue to work correctly regardless of delta threshold.

**Impact:**
- Covers now make fewer, larger adjustments as intended
- Clean position history charts with meaningful movements
- Reduced motor wear and noise from constant small movements

**Fixed: Custom Position Interpolation Boundary Handling (Issue #8)**

Corrected boundary condition handling in custom position interpolation for position-capable covers, preventing edge case errors when transitioning between sun tracking and special positions.

**Fixed: Covers Not Moving When Sun Comes Into Field of View**

Previously, covers wouldn't reposition when the sun transitioned into view if the calculated position (after min/max clamping) equaled the current position. This commonly occurred at sunrise with low sun angles (2-5¬∞ elevation) when min_position = 0%.

### ‚ö° Performance Improvements

**Reduced Position Verification Interval**
- Changed from 2 minutes to 1 minute
- More responsive to manual adjustments and override detection
- Better user experience with faster state updates

### üìã New Configuration Options

**Window Depth Parameter (Optional)**

| Parameter | Type | Range | Default | Description |
|-----------|------|-------|---------|-------------|
| window_depth | number | 0-50 cm | 0 | Depth/thickness of window frame for 3D shadow calculations |

This parameter is completely optional and defaults to 0 (disabled). Existing installations work without modification.

### üîß Technical Details

**Geometric Accuracy Enhancements:**
- `_handle_edge_cases()` - Robust handling of extreme sun angles
- `_calculate_safety_margin()` - Dynamic margin calculation (1.0-1.35x multiplier)
- Window depth integration - 3D vector calculations when configured
- Smoothstep interpolation - Prevents jarring position changes

**Delta Position Enforcement:**
- `coordinator.py` line 586: Timed refresh validation
- `coordinator.py` line 1417: Position verification retry validation
- `button.py` line 85: Manual override reset validation

**Test Coverage:**
- 225+ total tests passing
- 92% coverage on calculation.py
- 6 new tests for delta_position enforcement
- 34 tests for geometric accuracy
- All regression tests passing

### üì¶ Installation

**Via HACS (Recommended):**
1. Go to HACS ‚Üí Integrations
2. Find "Adaptive Cover Pro"
3. Click "Update" or "Redownload"
4. Select version `v2.6.16`
5. Restart Home Assistant

**Manual Installation:**
1. Download `adaptive_cover_pro.zip` from this release
2. Extract to `custom_components/adaptive_cover_pro/`
3. Restart Home Assistant

### üîÑ Upgrading

**From v2.6.15:**
- Enhanced shadow calculation accuracy
- Fixed minimum position adjustment enforcement
- Fixed interpolation boundary bugs
- No breaking changes
- Existing configurations work without modification
- Optional: Add window_depth parameter if you have recessed windows

**Configuration Changes:**
- No changes required to existing configurations
- All new features are optional enhancements
- Safety margins apply automatically (not configurable)

### ‚ö†Ô∏è Expected Behavior Changes

**Shadow Calculations:**
- Slightly higher blind positions at extreme angles (improved sun blocking)
- More accurate shadow projections across all sun positions
- Smoother position transitions throughout the day

**Position Adjustments:**
- Fewer, larger position changes (respects delta_position setting)
- No more "stairstepping" from constant 1% adjustments
- Special positions (0%, 100%, sunset) continue to work regardless of delta

**Sun Tracking Responsiveness:**
- Immediate response when sun enters field of view
- Faster manual override detection (1 minute vs 2 minutes)
- Better handling of sunrise/sunset transitions

### üß™ Tested Scenarios

‚úÖ Window depth parameter with various values (0cm, 5cm, 10cm, 15cm, 20cm)
‚úÖ Sunrise scenarios with low sun angles (2-10¬∞ elevation)
‚úÖ Various delta_position configurations (5%, 10%, 15%, 20%)
‚úÖ Various min_position/max_position configurations
‚úÖ Different window orientations and azimuths
‚úÖ Multiple covers controlled by single integration instance
‚úÖ Climate mode enabled configurations
‚úÖ All cover types (vertical, horizontal, tilt)

### üìù Related Issues

- Fixes #1 - Shadow calculation accuracy improvements
- Fixes #8 - Custom position interpolation boundary handling
- Fixes #10 - Minimum position adjustment setting ignored

### üôè Credits

Thank you to all users who reported issues, provided feedback, and tested beta releases:
- Issue #1: Shadow accuracy feedback
- Issue #8: Interpolation boundary bug report
- Issue #10: Delta position bug report with detailed diagnostics

Your detailed reports and testing helped make this release possible!

### üìä Statistics

- 7 beta releases tested before stable
- 3 major bug fixes
- 2 new features
- 40+ test cases added
- Home Assistant 2024.5.0+ compatible
- Python 3.11+ compatible
