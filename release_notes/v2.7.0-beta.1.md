# v2.7.0-beta.1 - Enhanced Geometric Accuracy (Beta)

## ðŸŽ¯ Beta Release - Testing Needed

This beta release introduces significant improvements to shadow/glare calculation accuracy, especially at extreme sun angles. **We need your help testing these changes!**

**What to test:**
- Monitor blind positions at extreme sun angles (early morning, late afternoon, winter months)
- Check for sun "leaking" past blinds at challenging positions
- Verify smooth transitions as sun moves throughout the day
- Confirm no regressions in normal operating conditions

**How to report issues:**
- Open a GitHub issue with sun angle details (check diagnostic sensors)
- Include screenshots if sun is leaking past blinds
- Note your window configuration (height, glare zone distance, window depth if configured)

## âœ¨ Features

### Automatic Geometric Improvements (Phase 1)

No configuration required - all users benefit automatically:

- **Angle-dependent safety margins** that automatically increase blind extension by 0-35% at extreme angles
  - Horizontal angles (gamma > 45Â°): Up to 20% increase
  - Low elevations (<10Â°): Up to 15% increase
  - High elevations (>75Â°): Up to 10% increase
  - Margins combine multiplicatively at extreme combinations

- **Robust edge case handling** for extreme sun positions
  - Elevation < 2Â°: Full window coverage
  - |Gamma| > 85Â°: Full window coverage
  - Elevation > 88Â°: Simplified calculation

- **Smooth transitions** using smoothstep interpolation
  - No sudden jumps at threshold crossings
  - Gradual, comfortable adjustments throughout the day

### Optional Window Depth Parameter (Phase 2)

Advanced feature for maximum precision:

- **New configuration parameter:** Window Depth (Reveal)
  - Range: 0.0 - 0.5 meters (0 - 50cm)
  - Default: 0.0 (disabled)
  - Located in vertical blind configuration

- **What it does:** Accounts for window reveals/frames creating additional shadow at angled sun positions

- **Typical values:**
  - 0.0m - Disabled (default, uses Phase 1 only)
  - 0.05m (2") - Flush-mounted windows
  - 0.10m (4") - Standard window frames
  - 0.15m (6") - Deep reveals or thick walls

- **When to use:** Only if you notice sun leaking at angles after Phase 1 improvements, or have deep window reveals (>10cm)

## ðŸ› Bug Fixes

- Fixed geometric accuracy issues at extreme sun angles (Issue #1)
- Resolved numerical instability at gamma angles >85Â°
- Improved sun blocking at very low elevations (<10Â°)
- Enhanced calculation reliability at high elevations (>75Â°)

## ðŸ“š Documentation

- Added comprehensive "Enhanced Geometric Accuracy" section to README
- Detailed technical documentation in CLAUDE.md
- Clear measurement instructions for window depth parameter
- Troubleshooting guide for common questions

## ðŸ§ª Testing

### Beta Testing Instructions

1. **Enable diagnostic sensors** (if not already enabled)
   - Go to integration options â†’ Automation settings
   - Enable "Enable Diagnostics"
   - Key sensors to monitor:
     - `Calculated Position` - Raw position before adjustments
     - `Sun Gamma` - Horizontal angle
     - `Sun Elevation` - Vertical angle
     - `Control Status` - Shows active adjustments

2. **Monitor throughout the day**
   - Pay special attention to:
     - Early morning (sun at low elevation)
     - Late afternoon (sun at extreme angles)
     - Times when sun was previously leaking past blinds

3. **Try window depth (optional)**
   - If you have deep window reveals, try configuring window depth
   - Measure from outer wall to inner window frame edge
   - Start with 0.10m and adjust if needed

4. **Report feedback**
   - What's working well
   - Any issues with sun leaking
   - Unexpected blind behavior
   - Performance concerns

### Test Coverage

- 34 new tests for geometric accuracy
- 214 total tests (all passing)
- 92% code coverage on calculation engine
- Regression tests confirm <5% deviation at normal angles
- Backward compatibility verified

## ðŸ”§ Technical Details

### Breaking Changes

None - fully backward compatible.

### New Configuration Options

- `window_depth` (optional, default 0.0): Window reveal/frame depth in meters

### Implementation

- Enhanced `AdaptiveVerticalCover.calculate_position()` in calculation.py
- New methods: `_calculate_safety_margin()`, `_handle_edge_cases()`
- Smoothstep interpolation for all safety margin transitions
- Optional window depth contribution at angles >10Â°

### Performance

- Minimal computational overhead (<1ms per calculation)
- No impact on Home Assistant performance
- All calculations remain synchronous and deterministic

## ðŸ“¦ Installation

### For Beta Testing

**HACS:**
1. Go to HACS â†’ Integrations â†’ Adaptive Cover Pro
2. Click the three dots â†’ "Redownload"
3. Select version `v2.7.0-beta.1`
4. Restart Home Assistant

**Manual:**
```bash
cd custom_components/adaptive_cover_pro
git fetch origin
git checkout v2.7.0-beta.1
# Restart Home Assistant
```

### Requirements

- Home Assistant 2024.5.0 or newer
- Python 3.11+
- No new dependencies

## âš ï¸ Known Issues

None currently - this is a beta release for testing.

Please report any issues at: https://github.com/jrhubott/adaptive-cover/issues

## ðŸ™ Credits

Special thanks to all users who reported issues with shadow calculation accuracy. Your detailed feedback made these improvements possible.

---

**Note:** This is a beta release. While thoroughly tested, we recommend monitoring your blinds closely for the first few days. You can always roll back to v2.6.13 if you encounter issues.
